USING ABLContainer.Bootstrap.* FROM PROPATH.
USING ABLContainer.Configuration.* FROM PROPATH.
USING ABLContainer.DockerSwarm.* FROM PROPATH.
USING ABLContainer.Logging.* FROM PROPATH.
USING Serilog.* FROM ASSEMBLY.
USING Serilog.Events.* FROM ASSEMBLY.
USING Serilog.Formatting.* FROM ASSEMBLY.
USING System.Collections.Generic.* FROM ASSEMBLY.

BLOCK-LEVEL ON ERROR UNDO, THROW.

CLASS ABLContainer.Bootstrap.Bootstrap:

  DEFINE PUBLIC STATIC PROPERTY ConnectionStrings AS "System.Collections.Generic.List<character>" NO-UNDO
    GET.
    SET.

  DEFINE PUBLIC STATIC PROPERTY StartupProcedure AS CHARACTER NO-UNDO
    GET.
    SET.

  DEFINE PUBLIC STATIC PROPERTY UseProfiler AS LOGICAL NO-UNDO
    GET.
    SET.

  DEFINE PUBLIC STATIC PROPERTY VersionNumber AS CHARACTER NO-UNDO
    GET.
    SET.

  METHOD PUBLIC STATIC Configuration BuildConfiguration(environment AS CHARACTER):

    DEFINE VARIABLE configurationBuilder AS ConfigurationBuilder NO-UNDO.
    DEFINE VARIABLE configuration        AS Configuration        NO-UNDO.

    configurationBuilder = NEW ConfigurationBuilder().
    configurationBuilder
      :SetBasePath(".")
      :AddJsonFile("appsettings.json", TRUE)
      :AddJsonFile("appsettings.override.json", TRUE)
      :AddJsonFile(SUBSTITUTE("appsettings.&1.json", environment), TRUE)
      :AddKeyPerFile(".\secrets", TRUE)
      :AddKeyPerFile("C:\ProgramData\Docker\secrets", TRUE)
      :AddEnvironmentVariables().
    configuration = configurationBuilder:Build().
    ABLContainer.Configuration.Configuration:Current = configuration.

    RETURN configuration.
  END METHOD.

  METHOD PUBLIC STATIC VOID SetSettings(configuration AS Configuration):
    /* configure logging first */
    SetSeriLogSettings(configuration).

    SetOpenEdgeSettings(configuration).

  END METHOD.

  METHOD PUBLIC STATIC VOID Start(environment AS CHARACTER):
    ConnectionStrings = NEW "System.Collections.Generic.List<character>"().
    VersionNumber = "1.0.1".

    DEFINE VARIABLE configuration AS Configuration NO-UNDO.
    configuration = BuildConfiguration(environment).

    SetSettings(configuration).

    Log:Information("OpenEdge version: 橡孱配珏皱蝮轱铪孪亘幸现乓由衔ū┅┊田绾深骘蝽狒轱瞑铄蝓铘轫鲥蝮轱詈娘纛弭阴铘轫逯弪箝镱", System.Environment:Version).

    Log:Information("ABLContainer version: 谅堂镱翎轭弪皱蝮轱铪孪亘皱蝮轱钗蹴忮颟┊田绾深骘蝽狒轱瞑⒂翎螋躔序镢邃躜搴郁狎趱鹦蝻沐漉蝈", BOX(StartupProcedure)).
    Log:Information("ProPath: 序镄狒棹孪亘幸闲猎醛┊田绾深骘蝽狒轱瞑⒄箦序镦殪弪阵逍蝻骈戾蟒孪亘阵逍蝻骈戾颟┊善ㄎ显蔑铑邈粼锬狒徕狍弩ī匀盼南遗哉椅盼漠盘优南善阵逍蝻骈戾匀盼南嫌靡帕耘纳至陶浓痱镦殪澧┊幸掀商乓号瘟绿拍砸张幸掀商乓耗梢琶韵屹痱镦殪澧幸掀商乓浩商怒瘟团诱掠陨哉耘á痱镦殪瀵痱镦殪弪擀边Σ擀忱Υ痱镦倥烈ㄔ夏临┈拖卧权韵牧侃牧侉韵牧侃遗刑撩浓釉疑吻ㄔ赏努⑷群屯河英┈⒑┅幸掀商乓禾捎陨吻砸张幸掀商乓耗庞靡尚陨衔⑿蚁粕膛尧幸掀商乓盒蚁粕躺吻砸张幸掀商乓涸伊门粕淘乓盼漠团佑燎⒂翎螋躔序镢邃躜瀛劲郁狎趱鹦蝻沐漉蝈团佑燎⑿蝻嗅翳劲阵逍蝻嗅翳团佑燎⒄箦序镦殪弪劲釉疑吻ㄕ箦序镦殪弪┊趄犷蝓翳篝狎趱痱镢邃躜善郁狎趱鹦蝻沐漉蝈弦ㄓ帕颐权郁狎趱鹦蝻沐漉蝈廖优烈萌ㄒ判塘门ㄓ翎螋躔序镢邃躜瀣稷颌┅咯匀盼南田绾膨蝻颞⑴乙弦篝狎趱痱镢邃躜郁狎趱鹦蝻沐漉蝈) not found!", BOX(StartupProcedure)).
        RETURN.
      END.

      _RUNNING_LOOP:
      DO ON STOP UNDO, LEAVE
        ON ERROR UNDO, LEAVE:

        RUN VALUE(StartupProcedure).

        CATCH er AS Progress.Lang.Error :
          Log:Error("Fatal error (膨蝻蛟疱) [膨蝻蛲弩筢珏].", BOX(STRING(er)), BOX(er:GetMessage(1))).
          LEAVE _RUNNING_LOOP.
        END CATCH.
      END.
    END. /* databases connected */

    IF UseProfiler THEN DO:
      /*turn off profiler and flush the data*/
      PROFILER:ENABLED = FALSE.
      PROFILER:PROFILING = FALSE.
      PROFILER:WRITE-DATA().
    END.

  END METHOD.

  METHOD PUBLIC STATIC VOID SetSeriLogSettings(configuration AS Configuration):
    DEFINE VARIABLE addTestingLogger AS LOGICAL NO-UNDO.

    DEFINE VARIABLE serilogSection AS ConfigurationSection NO-UNDO.
    serilogSection = configuration:GetSection("SeriLog").
    IF NOT VALID-OBJECT(serilogSection) THEN DO:
      RETURN.
    END.

    DEFINE VARIABLE dockerSwarmDetails AS DockerSwarmDetails NO-UNDO.
    dockerSwarmDetails = GetSwarmDetails().

    DEFINE VARIABLE loggerConfiguration AS LoggerConfiguration NO-UNDO.
    loggerConfiguration = NEW loggerConfiguration().

    DEFINE VARIABLE keyvaluepairs AS "IList<System.Collections.Generic.KeyValuePair<character, character>>" NO-UNDO.
    keyvaluepairs = NEW "List<System.Collections.Generic.KeyValuePair<character, character>>"().

    DEFINE VARIABLE addLogContext AS LOGICAL NO-UNDO.

    DEFINE VARIABLE serilogEnumerator AS "System.Collections.Generic.Dictionary<CHARACTER, System.Object>+Enumerator" NO-UNDO.
    serilogEnumerator = serilogSection:GetChildren().
    _SERILOG:
    DO WHILE(serilogEnumerator:MoveNext()):

      DEFINE VARIABLE configurationSection AS ConfigurationSection NO-UNDO.
      configurationSection = CAST(serilogEnumerator:Current:Value, ConfigurationSection).

      /*      MESSAGE SUBSTITUTE("configurationSection &1->&2", configurationSection:Key, configurationSection:Value).*/

      IF configurationSection:Key = "Using" THEN DO:
        DEFINE VARIABLE usingEnumerator AS "System.Collections.Generic.Dictionary<CHARACTER, System.Object>+Enumerator" NO-UNDO.
        usingEnumerator = configurationSection:GetChildren().
        _USING:
        DO WHILE(usingEnumerator:MoveNext()):
          DEFINE VARIABLE usingSection AS ConfigurationSection NO-UNDO.
          usingSection = CAST(usingEnumerator:Current:Value, ConfigurationSection).
          /*          MESSAGE SUBSTITUTE("Using &1->&2", usingSection:Key, usingSection:Value).*/

          DEFINE VARIABLE cLastPart AS CHARACTER NO-UNDO.
          cLastPart = SUBSTRING(usingSection:Value, R-INDEX(usingSection:Value, ".") + 1).
          keyvaluepairs:Add(NEW "System.Collections.Generic.KeyValuePair<character, character>"("using:" + cLastPart, usingSection:Value)).
        END. /*_USING*/
      END.
      ELSE IF configurationSection:Key = "MinimumLevel" THEN DO:
        DEFINE VARIABLE minLevelEnumerator AS "System.Collections.Generic.Dictionary<CHARACTER, System.Object>+Enumerator" NO-UNDO.
        minLevelEnumerator = configurationSection:GetChildren().
        _MINLEVEL:
        DO WHILE(minLevelEnumerator:MoveNext()):
          DEFINE VARIABLE minLevelSection AS ConfigurationSection NO-UNDO.
          minLevelSection = CAST(minLevelEnumerator:Current:Value, ConfigurationSection).

          IF minLevelSection:Key = "Default" THEN DO:
            keyvaluepairs:Add(NEW "System.Collections.Generic.KeyValuePair<character, character>"("minimum-level", minLevelSection:Value)).
          END.
          ELSE IF minLevelSection:Key = "Override" THEN DO:
            DEFINE VARIABLE overrideEnumerator AS "System.Collections.Generic.Dictionary<CHARACTER, System.Object>+Enumerator" NO-UNDO.
            overrideEnumerator = minLevelSection:GetChildren().
            _OVERRIDE:
            DO WHILE(overrideEnumerator:MoveNext()):
              DEFINE VARIABLE overrideSection AS ConfigurationSection NO-UNDO.
              overrideSection = CAST(overrideEnumerator:Current:Value, ConfigurationSection).

              keyvaluepairs:Add(NEW "System.Collections.Generic.KeyValuePair<character, character>"("minimum-level:override:" + overrideSection:Key, overrideSection:Value)).
            END.
          END.
        END.
      END.
      ELSE IF configurationSection:Key = "WriteTo" THEN DO:
        DEFINE VARIABLE writeToEnumerator AS "System.Collections.Generic.Dictionary<CHARACTER, System.Object>+Enumerator" NO-UNDO.
        writeToEnumerator = configurationSection:GetChildren().
        _WRITETO:
        DO WHILE(writeToEnumerator:MoveNext()):
          DEFINE VARIABLE writeToSection AS ConfigurationSection NO-UNDO.
          writeToSection = CAST(writeToEnumerator:Current:Value, ConfigurationSection).

          DEFINE VARIABLE nameSection AS ConfigurationSection NO-UNDO.
          nameSection = writeToSection:GetSection("Name").
          IF nameSection:VALUE = ? THEN DO:
            NEXT _WRITETO.
          END.

          DEFINE VARIABLE writeToName AS CHARACTER NO-UNDO.
          writeToName = nameSection:Value.

          IF writeToName = "Testing" THEN DO:
            addTestingLogger = TRUE.
            NEXT _WRITETO.
          END.

          keyvaluepairs:Add(NEW "System.Collections.Generic.KeyValuePair<System.String, System.String>"("write-to:" + writeToName, "")).

          DEFINE VARIABLE writeToSettingEnumerator AS "System.Collections.Generic.Dictionary<CHARACTER, System.Object>+Enumerator" NO-UNDO.
          writeToSettingEnumerator = writeToSection:GetChildren().
          _WRITETO_SETTINGS:
          DO WHILE(writeToSettingEnumerator:MoveNext()):
            DEFINE VARIABLE writeToSettingSection AS ConfigurationSection NO-UNDO.
            writeToSettingSection = CAST(writeToSettingEnumerator:Current:Value, ConfigurationSection).

            /*            MESSAGE SUBSTITUTE("writeToSettingSection &1->&2", writeToSettingSection:Key, writeToSettingSection:Value).*/
            IF writeToSettingSection:Key = "Args" THEN DO:
              DEFINE VARIABLE argsEnumerator AS "System.Collections.Generic.Dictionary<CHARACTER, System.Object>+Enumerator" NO-UNDO.
              argsEnumerator = writeToSettingSection:GetChildren().
              _ARGS:
              DO WHILE(argsEnumerator:MoveNext()):
                DEFINE VARIABLE argsSection AS ConfigurationSection NO-UNDO.
                argsSection = CAST(argsEnumerator:Current:Value, ConfigurationSection).

                /*                MESSAGE SUBSTITUTE("argsSection &1->&2", argsSection:Key, argsSection:Value).*/
                keyvaluepairs:Add(NEW "System.Collections.Generic.KeyValuePair<character, character>"("write-to:" + writeToName + "." + argsSection:Key, argsSection:Value)).
              END. /*_ARGS*/
            END.
          END. /*_WRITETO_SETTINGS*/

        END. /*_WRITETO*/
      END.
      ELSE IF configurationSection:Key = "Enrich" THEN DO:
        DEFINE VARIABLE enrichEnumerator AS "System.Collections.Generic.Dictionary<CHARACTER, System.Object>+Enumerator" NO-UNDO.
        enrichEnumerator = configurationSection:GetChildren().
        _ENRICH:
        DO WHILE(enrichEnumerator:MoveNext()):
          DEFINE VARIABLE enrichSection AS ConfigurationSection NO-UNDO.
          enrichSection = CAST(enrichEnumerator:Current:Value, ConfigurationSection).
          /*          MESSAGE SUBSTITUTE("Enrich &1->&2", enrichSection:Key, enrichSection:Value).*/

          IF enrichSection:Value = "WithMachineName" THEN DO:
            keyvaluepairs:Add(NEW "System.Collections.Generic.KeyValuePair<character, character>"("enrich:with-property:MachineName", System.Environment:MachineName)).
          END.
          ELSE IF enrichSection:Value = "FromLogContext" THEN DO:
            addLogContext = TRUE.
          END.
          ELSE IF enrichSection:Value = "WithSwarmNodeID" THEN DO:
/*            Serilog.Context.LogContext:PushProperty("SwarmNodeID", dockerSwarmDetails:Node:ID, FALSE).*/
            keyvaluepairs:Add(NEW "System.Collections.Generic.KeyValuePair<character, character>"("enrich:with-property:SwarmNodeID", dockerSwarmDetails:Node:ID)).
          END.
          ELSE IF enrichSection:Value = "WithSwarmNodeHostname" THEN DO:
/*            Serilog.Context.LogContext:PushProperty("SwarmNodeHostname", dockerSwarmDetails:Node:Hostname, FALSE).*/
            keyvaluepairs:Add(NEW "System.Collections.Generic.KeyValuePair<character, character>"("enrich:with-property:SwarmNodeHostname", dockerSwarmDetails:Node:Hostname)).
          END.
          ELSE IF enrichSection:Value = "WithSwarmServiceID" THEN DO:
/*            Serilog.Context.LogContext:PushProperty("SwarmServiceID", dockerSwarmDetails:Service:ID, FALSE).*/
            keyvaluepairs:Add(NEW "System.Collections.Generic.KeyValuePair<character, character>"("enrich:with-property:SwarmServiceID", dockerSwarmDetails:Service:ID)).
          END.
          ELSE IF enrichSection:Value = "WithSwarmServiceName" THEN DO:
/*            Serilog.Context.LogContext:PushProperty("SwarmServiceName", dockerSwarmDetails:Service:Name, FALSE).*/
            keyvaluepairs:Add(NEW "System.Collections.Generic.KeyValuePair<character, character>"("enrich:with-property:SwarmServiceName", dockerSwarmDetails:Service:Name)).
          END.
          ELSE IF enrichSection:Value = "WithSwarmServiceLabels" THEN DO:
/*            Serilog.Context.LogContext:PushProperty("SwarmServiceLabels", dockerSwarmDetails:Service:Labels, FALSE).*/
            keyvaluepairs:Add(NEW "System.Collections.Generic.KeyValuePair<character, character>"("enrich:with-property:SwarmServiceLabels", dockerSwarmDetails:Service:Labels)).
          END.
          ELSE IF enrichSection:Value = "WithSwarmTaskID" THEN DO:
/*            Serilog.Context.LogContext:PushProperty("SwarmTaskID", dockerSwarmDetails:Task:ID, FALSE).*/
            keyvaluepairs:Add(NEW "System.Collections.Generic.KeyValuePair<character, character>"("enrich:with-property:SwarmTaskID", dockerSwarmDetails:Task:ID)).
          END.
          ELSE IF enrichSection:Value = "WithSwarmTaskName" THEN DO:
/*            Serilog.Context.LogContext:PushProperty("SwarmTaskName", dockerSwarmDetails:Task:Name, FALSE).*/
            keyvaluepairs:Add(NEW "System.Collections.Generic.KeyValuePair<character, character>"("enrich:with-property:SwarmTaskName", dockerSwarmDetails:Task:Name)).
          END.
          ELSE IF enrichSection:Value = "WithSwarmTaskSlot" THEN DO:
/*            Serilog.Context.LogContext:PushProperty("SwarmTaskSlot", dockerSwarmDetails:Task:Slot, FALSE).*/
            keyvaluepairs:Add(NEW "System.Collections.Generic.KeyValuePair<character, character>"("enrich:with-property:SwarmTaskSlot", dockerSwarmDetails:Task:Slot)).
          END.
          ELSE IF enrichSection:Value = "WithProcessId" THEN DO:
/*            Serilog.Context.LogContext:PushProperty("ProcessId", System.Diagnostics.Process:GetCurrentProcess():Id, FALSE).*/
            keyvaluepairs:Add(NEW "System.Collections.Generic.KeyValuePair<character, character>"("enrich:with-property:ProcessId", STRING(System.Diagnostics.Process:GetCurrentProcess():Id))).
          END.
        END. /*_ENRICH*/
      END.
      ELSE IF configurationSection:Key = "Properties" THEN DO:
        DEFINE VARIABLE propertyEnumerator AS "System.Collections.Generic.Dictionary<CHARACTER, System.Object>+Enumerator" NO-UNDO.
        propertyEnumerator = configurationSection:GetChildren().
        _PROPERTY:
        DO WHILE(propertyEnumerator:MoveNext()):
          DEFINE VARIABLE propertySection AS ConfigurationSection NO-UNDO.
          propertySection = CAST(propertyEnumerator:Current:Value, ConfigurationSection).
          /*          MESSAGE SUBSTITUTE("Properties &1->&2", usingSection:Key, usingSection:Value).*/

          keyvaluepairs:Add(NEW "System.Collections.Generic.KeyValuePair<character, character>"("enrich:with-property:" + propertySection:Key, propertySection:Value)).
        END. /*_PROPERTY*/
      END.

    END. /*SERILOG*/

    loggerConfiguration:ReadFrom:KeyValuePairs(keyvaluepairs).
    IF addLogContext THEN DO:
      loggerConfiguration:Enrich:FromLogContext().
    END.

    /* allow hook into logs for testing */
    IF addTestingLogger THEN DO:
      DEFINE VARIABLE textFormatter AS ITextFormatter NO-UNDO.
      textFormatter = DYNAMIC-INVOKE("ABLContainer.Logging.TestFormatter", "GetFormatter").
      loggerConfiguration = Serilog.ConsoleLoggerConfigurationExtensions:Console(loggerConfiguration:WriteTo, textFormatter, LogEventLevel:Debug, ?, ?).
    END.

    Serilog.Log:Logger = loggerConfiguration:CreateLogger().

    Serilog.Log:Logger:Information("Serilog has been configured.").

    DEFINE VARIABLE kvpEnumerator AS "System.Collections.Generic.IEnumerator<System.Collections.Generic.KeyValuePair<character, character>>" NO-UNDO.
    kvpEnumerator = keyvaluepairs:GetEnumerator().
    DO WHILE(kvpEnumerator:MoveNext()):
      Serilog.Log:Logger:Debug(SUBSTITUTE("    Serilog setting: &1=&2", kvpEnumerator:Current:Key, kvpEnumerator:Current:Value)).
    END.

    DEFINE VARIABLE configurationEnumerator AS "System.Collections.Generic.Dictionary<CHARACTER, CHARACTER>+Enumerator" NO-UNDO.
    configurationEnumerator = ABLContainer.Configuration.Configuration:Current:GetChildren().

    Log:Debug("Configuration").
    DO WHILE(configurationEnumerator:MoveNext()):
      Log:Debug("  隋=轴祯妣孪亘泔铈殓躜狒轱钆铛礤蜥麸蚝悯蝌孱艉隋┈孪亘泔铈殓躜狒轱钆铛礤蜥麸蚝悯蝌孱艉轴祯濠┊盼漠盼团匀夏团匀夏幸芍猎釉猎擅娘汶弪喻狎砟弭衢祗清粲麽蝽腻翎殪蟥┖呐粕闻至疑谅膛滹汶弪喻狎砟弭衢祗劣娘汶弪喻狎砟弭衢祗蜗瘴南滹汶弪喻狎砟弭衢祗闻娘汶弪喻狎砟弭衢祗ī滹汶弪喻狎砟弭衢祗何镤闻物溴ī滹汶弪喻狎砟弭衢祗何镤搴赡御篝屙蓬鲩蝻铐孱艉清襞铞轵镱礤铘轴蜷徕戾á幼烈瓦蜗呐呱蘑┊滹汶弪喻狎砟弭衢祗何镤搴蕊篝钺礤御篝屙蓬鲩蝻铐孱艉清襞铞轵镱礤铘轴蜷徕戾á幼烈瓦蜗呐呷嫌晕镣泞┊滹汶弪喻狎砟弭衢祗河弪鲩沐闻渝蝣殂濞┊滹汶弪喻狎砟弭衢祗河弪鲩沐荷御篝屙蓬鲩蝻铐孱艉清襞铞轵镱礤铘轴蜷徕戾á幼烈瓦优抑擅胚赡┊滹汶弪喻狎砟弭衢祗河弪鲩沐何犴御篝屙蓬鲩蝻铐孱艉清襞铞轵镱礤铘轴蜷徕戾á幼烈瓦优抑擅胚瘟团┊滹汶弪喻狎砟弭衢祗河弪鲩沐禾徕屐御篝屙蓬鲩蝻铐孱艉清襞铞轵镱礤铘轴蜷徕戾á幼烈瓦优抑擅胚塘屡逃┊滹汶弪喻狎砟弭衢祗涸狍闻葬箅ī滹汶弪喻狎砟弭衢祗涸狍牒赡御篝屙蓬鲩蝻铐孱艉清襞铞轵镱礤铘轴蜷徕戾á幼烈瓦粤铀呱蘑┊滹汶弪喻狎砟弭衢祗涸狍牒吾礤御篝屙蓬鲩蝻铐孱艉清襞铞轵镱礤铘轴蜷徕戾á幼烈瓦粤铀呶镣泞┊滹汶弪喻狎砟弭衢祗涸狍牒屿雉御篝屙蓬鲩蝻铐孱艉清襞铞轵镱礤铘轴蜷徕戾á幼烈瓦粤铀哂滔寓┊遗哉椅滹汶弪喻狎砟弭衢祗盼团匀夏团匀夏姓绿擅釉猎擅滔巧昧蔑铑邈粼锬狒徕狍弩ī呐粕闻至疑谅膛泔铑邈糸镱郁蜷铉笈铛礤蜥麸劣⒂篝屙蔑祆邈糸镱螽清铄蜷惝涕篝笺栳蜥泗弪精蓬蹴弪狒矧蜗瘴南泔铑邈糸镱郁蜷铉笈铛礤蜥麸蔑铑邈糸镱郁蜷铉蠛清襞铛礤蜥麸颞┊南兹商浓泔铑邈糸镱郁蜷铉笈铛礤蜥麸蚝惋鲥五舁┅呐粕闻至疑谅膛溽翎忉箦蔑铑邈糸镱郁蜷铉劣萌烈撩耘蜗瘴南呐粕闻至疑谅膛蝈溽泗邃尼翎忉箦蔑铑邈糸镱郁蜷铉劣萌烈撩耘蜗瘴南溽翎忉箦蔑铑邈糸镱郁蜷铉泔铑邈糸镱郁蜷铉笈铛礤蜥麸蚝悯蝌孱舢蝈溽泗邃尼翎忉箦蔑铑邈糸镱郁蜷铉溽翎忉箦蔑铑邈糸镱郁蜷铉呐粕闻至疑谅膛疳篌黠蜾深溴劣晌耘桥蜗瘴南疳篌黠蜾深溴滔纤招á孝溽翎忉箦蔑铑邈糸镱郁蜷铉┊善疳篌黠蜾深溴季匀盼南疳篌黠蜾深溴疳篌黠蜾深溴碑蝈溽泗邃尼翎忉箦蔑铑邈糸镱郁蜷铉溽翎忉箦蔑铑邈糸镱郁蜷铉盼砸侉疳篌黠蜾深溴蝈溽泗邃尼翎忉箦蔑铑邈糸镱郁蜷铉粕烫á膛吻匀ㄅ卧屹疳篌黠蜾深溴蝈溽泗邃尼翎忉箦蔑铑邈糸镱郁蜷铉┅┊盼漠田绾深骘蝽狒轱瞑⒚镱铄泗轭麸溽翎忉箦鏖翳泔铑邈糸镱篝蜷铉蔑铑邈糸镱郁蜷铉)...", BOX(redactedDatabaseConnectionString)).
      CONNECT VALUE(databaseConnectionString) NO-ERROR.
      IF ERROR-STATUS:NUM-MESSAGES > 0 THEN DO:
        Log:Error("ERROR: Couldn't connect to database!").
        Log:Error("ERROR: 膨蝻蛲弩筢珏", BOX(ERROR-STATUS:GET-MESSAGE(1))).
        RETURN FALSE.
      END.
    END.

    RETURN TRUE.
  END.

  METHOD PUBLIC STATIC VOID SetOpenEdgeSettings(configuration AS Configuration):
    DEFINE VARIABLE openedgeSection AS ConfigurationSection NO-UNDO.
    openedgeSection = configuration:GetSection("OpenEdge").
    IF NOT VALID-OBJECT(openedgeSection) THEN DO:
      RETURN.
    END.

    DEFINE VARIABLE openedgeEnumerator AS "System.Collections.Generic.Dictionary<CHARACTER, System.Object>+Enumerator" NO-UNDO.
    openedgeEnumerator = openedgeSection:GetChildren().
    _OPENEDGE:
    DO WHILE(openedgeEnumerator:MoveNext()):

      DEFINE VARIABLE configurationSection AS ConfigurationSection NO-UNDO.
      configurationSection = CAST(openedgeEnumerator:Current:Value, ConfigurationSection).

      /*      MESSAGE SUBSTITUTE("configurationSection &1->&2", configurationSection:Key, configurationSection:Value).*/

      IF configurationSection:Key = "startupProcedure" THEN DO:
        Bootstrap:StartupProcedure = configurationSection:Value.
      END.
      ELSE IF configurationSection:Key = "propath" THEN DO:
        /* trap error here as change of propath whilst .pl is loaded causes error */
        PROPATH = configurationSection:Value NO-ERROR.
      END.
      ELSE IF configurationSection:Key = "profiler" THEN DO:
        Bootstrap:UseProfiler = LOGICAL(configurationSection:VALUE).
      END.
      ELSE IF configurationSection:Key = "databases" THEN DO:
        DEFINE VARIABLE databaseSection     AS ConfigurationSection                                                         NO-UNDO.
        DEFINE VARIABLE databasesEnumerator AS "System.Collections.Generic.Dictionary<CHARACTER, System.Object>+Enumerator" NO-UNDO.

        databasesEnumerator = configurationSection:GetChildren().

        _DATABASE:
        DO WHILE(databasesEnumerator:MoveNext()):

          databaseSection = CAST(databasesEnumerator:Current:Value, ConfigurationSection).
          /*          MESSAGE SUBSTITUTE("databaseSection &1->&2", databaseSection:Key, databaseSection:Value).*/
          DEFINE VARIABLE dbSettingSection         AS ConfigurationSection                                                         NO-UNDO.
          DEFINE VARIABLE databaseEnumerator       AS "System.Collections.Generic.Dictionary<CHARACTER, System.Object>+Enumerator" NO-UNDO.

          DEFINE VARIABLE databaseConnectionString AS CHARACTER                                                                    NO-UNDO.

          databaseConnectionString = "".
          databaseEnumerator = databaseSection:GetChildren().
          _DB_SETTING:
          DO WHILE(databaseEnumerator:MoveNext()):
            dbSettingSection = CAST(databaseEnumerator:Current:Value, ConfigurationSection).
            /*            MESSAGE SUBSTITUTE("dbSettingSection &1->&2", dbSettingSection:Key, dbSettingSection:Value).*/

            IF dbSettingSection:Key = ("db") THEN DO:
              databaseConnectionString = databaseConnectionString + " -db " + dbSettingSection:Value.
            END.
            ELSE IF dbSettingSection:Key = ("host") THEN DO:
              databaseConnectionString = databaseConnectionString + " -H " + dbSettingSection:Value.
            END.
            ELSE IF dbSettingSection:Key = ("port") THEN DO:
              databaseConnectionString = databaseConnectionString + " -S " + dbSettingSection:Value.
            END.
            ELSE IF dbSettingSection:Key = ("logical") THEN DO:
              databaseConnectionString = databaseConnectionString + " -ld " + dbSettingSection:Value.
            END.
            ELSE IF dbSettingSection:Key = ("username") THEN DO:
              databaseConnectionString = databaseConnectionString + " -U " + dbSettingSection:Value.
            END.
            ELSE IF dbSettingSection:Key = ("password") THEN DO:
              databaseConnectionString = databaseConnectionString + " -P " + dbSettingSection:Value.
            END.
            ELSE IF dbSettingSection:Key = ("other") THEN DO:
              databaseConnectionString = databaseConnectionString + " " + dbSettingSection:Value.
            END.
          END. /*_DB_SETTING*/

          IF databaseConnectionString <> "" THEN DO:
            /*remove first blank */
            databaseConnectionString = TRIM(databaseConnectionString).
            ABLContainer.Bootstrap.Bootstrap:ConnectionStrings:Add(databaseConnectionString).
          END.

        END. /*_DATABASE*/

      END. /*databases*/

    END. /*_OPENEDGE*/

  END METHOD.


END CLASS.
