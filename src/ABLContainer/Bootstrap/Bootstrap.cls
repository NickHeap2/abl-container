USING ABLContainer.Logging.* FROM PROPATH.
USING ABLContainer.Bootstrap.* FROM PROPATH.
USING ABLContainer.Configuration.* FROM PROPATH.
USING Progress.Lang.*.
USING Serilog.* FROM ASSEMBLY.
USING Serilog.Log.* FROM ASSEMBLY.
USING Serilog.Sinks.* FROM ASSEMBLY.
USING System.Collections.Generic.* FROM ASSEMBLY.

BLOCK-LEVEL ON ERROR UNDO, THROW.

CLASS ABLContainer.Bootstrap.Bootstrap: 

/*  DEFINE STATIC VARIABLE configuration AS Configuration NO-UNDO.*/

  DEFINE PUBLIC STATIC PROPERTY StartupProcedure AS CHARACTER NO-UNDO
  GET.
  SET.

  DEFINE PUBLIC STATIC PROPERTY UseProfiler AS LOGICAL NO-UNDO
  GET.
  SET.
  

  CONSTRUCTOR PUBLIC Bootstrap (  ):
    
  END CONSTRUCTOR.

  METHOD PUBLIC STATIC VOID SetApplicationSettings(configuration AS Configuration, applicationName AS CHARACTER):

    IF NOT VALID-OBJECT(configuration) THEN DO:
      RETURN.
    END.

    DEFINE VARIABLE applicationSection AS ConfigurationSection NO-UNDO.
    applicationSection = configuration:GetSection(applicationName).
    IF NOT VALID-OBJECT(applicationSection) THEN DO:
      RETURN.
    END.

    DEFINE VARIABLE currentDateFormat AS CHARACTER NO-UNDO.
    currentDateFormat = SESSION:DATE-FORMAT.

    SESSION:DATE-FORMAT = "YMD".

    // DEFINE VARIABLE applicationSettings AS Settings NO-UNDO.
    // applicationSettings = Settings:Current.
    
    DEFINE VARIABLE applicationEnumerator AS "System.Collections.Generic.Dictionary<CHARACTER, System.Object>+Enumerator" NO-UNDO.
    applicationEnumerator = applicationSection:GetChildren().
    _APPLICATION:
    DO WHILE(applicationEnumerator:MoveNext()):
      DEFINE VARIABLE configurationSection AS ConfigurationSection NO-UNDO.
      configurationSection = CAST(applicationEnumerator:Current:Value, ConfigurationSection).

      Log:Information("ApplicationSetting 隋=轴祯妣孪亘泔铈殓躜狒轱钣邈糸镱核妁┈孪亘泔铈殓躜狒轱钣邈糸镱褐犰蹂┅团佑燎诱掠陨哉耘á琉痨殂狒轱钣弭糸铉睛苯Σ泔铈殓躜狒轱钣邈糸镱核妁泔铈殓躜狒轱钣邈糸镱褐犰蹂┊馁瘟蜕铆幸闲乓再ㄡ痧扉汜糸镱渝趑轭珞泔铈殓躜狒轱钣邈糸镱核妁泔铈殓躜狒轱钣邈糸镱褐犰蹂盼漠优佑上魏牧耘葡彝猎沲蝌孱裟狒迤矧磲舢盼团匀夏团匀夏姓绿擅釉猎擅蔑铈殓躜狒轱迈殪涿镱骈珲蜥糸镱┖呐粕闻至疑谅膛泔铈殓躜狒轱盥蹰熹弪劣蔑铈殓躜狒轱盥蹰熹弪蜗瘴南呐粕闻至疑谅膛泔铈殓躜狒轱劣蔑铈殓躜狒轱蜗瘴南泔铈殓躜狒轱盥蹰熹弪闻蔑铈殓躜狒轱盥蹰熹弪ī泔铈殓躜狒轱盥蹰熹弪河弭箩箦嗅翳á毫滗鼠镱崎戾á狃痼弭糸铉螽牦镱砸张毫滗鼠镱崎戾á狃痼弭糸铉螽腻鲥祜痦孱舢牦镱砸张毫滗蓬鲩蝻铐孱糁狎獒忪弩ī泔铈殓躜狒轱泔铈殓躜狒轱盥蹰熹弪郝蹰熹ī遗哉椅泔铈殓躜狒轱町盼团匀夏团匀夏姓绿擅釉猎擅窒赡渝粲弭糸铉蟥泔铈殓躜狒轱劣蔑铈殓躜狒轱瞟泔铈殓躜祜珑轭骈蝮渝粲弪樘镧渝趑轭珞ㄣ镱骈珲蜥糸镱┊渝粝疱钆溏逵弭糸铉蟥泔铈殓躜狒轱瞟渝袅痧扉汜糸镱渝趑轭珞ㄣ镱骈珲蜥糸镱⒘痧扉汜糸镱┊盼团匀夏团匀夏姓绿擅釉猎擅窒赡郁狎舁┖呐粕闻至疑谅膛泔铈殓躜狒轱劣蔑铈殓躜狒轱蜗瘴南泔铈殓躜狒轱迈殪涿镱骈珲蜥糸镱ī渝粲弭糸铉蟥泔铈殓躜狒轱瞟善阵逍蝻骈戾匀盼南嫌靡帕耘纳至陶浓痱镦殪澧┊幸掀商乓号瘟绿拍砸张幸掀商乓耗梢琶韵屹痱镦殪澧幸掀商乓浩商怒瘟团诱掠陨哉耘á痱镦殪瀵痱镦殪弪擀边Σ擀忱Υ痱镦倥烈ㄔ夏临┈拖卧权韵牧侃牧侉韵牧侃遗刑撩浓釉疑吻ㄔ赏努⑷群屯河英┈⒑┅幸掀商乓禾捎陨吻砸张幸掀商乓耗庞靡尚陨衔⑿蚁粕膛尧幸掀商乓盒蚁粕躺吻砸张幸掀商乓涸伊门粕淘乓盼漠团佑燎⒂翎螋躔序镢邃躜瀛劲郁狎趱鹦蝻沐漉蝈团佑燎⑿蝻嗅翳劲阵逍蝻嗅翳团佑燎⒄箦序镦殪弪劲釉疑吻ㄕ箦序镦殪弪┊趄犷蝓翳篝狎趱痱镢邃躜善郁狎趱鹦蝻沐漉蝈弦ㄓ帕颐权郁狎趱鹦蝻沐漉蝈廖优烈萌ㄒ判塘门ㄓ翎螋躔序镢邃躜瀣稷颌┅咯匀盼南团佑燎痱镢铒骘躅洧田绾膨蝻颞⑴乙弦篝狎趱痱镢邃躜郁狎趱鹦蝻沐漉蝈) not found!", BOX(StartupProcedure)).
      RETURN.
    END.
    
    DO ON STOP UNDO, LEAVE
       ON ERROR UNDO, LEAVE:
    
      RUN VALUE(StartupProcedure).
    
      CATCH er AS Progress.Lang.Error :
        MESSAGE "fatal error".
        Log:Error("Fatal error (膨蝻蛟疱) [膨蝻蛲弩筢珏].", BOX(STRING(er)), BOX(er:GetMessage(1))).
      END CATCH.
    END.

    IF UseProfiler THEN DO:
      /*turn off profiler and flush the data*/
      PROFILER:ENABLED = FALSE.
      PROFILER:PROFILING = FALSE.
      PROFILER:WRITE-DATA().
    END.

  END METHOD.  
  
  METHOD PUBLIC STATIC VOID SetSeriLogSettings(configuration AS Configuration):
    DEFINE VARIABLE serilogSection AS ConfigurationSection NO-UNDO.
    serilogSection = configuration:GetSection("SeriLog").
    IF NOT VALID-OBJECT(serilogSection) THEN DO:
      RETURN.
    END.
  
    DEFINE VARIABLE loggerConfiguration AS LoggerConfiguration NO-UNDO.
    loggerConfiguration = NEW loggerConfiguration().
  
    DEFINE VARIABLE keyvaluepairs AS "IList<System.Collections.Generic.KeyValuePair<character, character>>" NO-UNDO.
    keyvaluepairs = NEW "List<System.Collections.Generic.KeyValuePair<character, character>>"().
  
    DEFINE VARIABLE serilogEnumerator AS "System.Collections.Generic.Dictionary<CHARACTER, System.Object>+Enumerator" NO-UNDO.
    serilogEnumerator = serilogSection:GetChildren().
    _SERILOG:
    DO WHILE(serilogEnumerator:MoveNext()):
      
      DEFINE VARIABLE configurationSection AS ConfigurationSection NO-UNDO.
      configurationSection = CAST(serilogEnumerator:Current:Value, ConfigurationSection).

/*      MESSAGE SUBSTITUTE("configurationSection &1->&2", configurationSection:Key, configurationSection:Value).*/

      IF configurationSection:Key = "Using" THEN DO:
        DEFINE VARIABLE usingEnumerator AS "System.Collections.Generic.Dictionary<CHARACTER, System.Object>+Enumerator" NO-UNDO.
        usingEnumerator = configurationSection:GetChildren().
        _USING:
        DO WHILE(usingEnumerator:MoveNext()):
          DEFINE VARIABLE usingSection AS ConfigurationSection NO-UNDO.
          usingSection = CAST(usingEnumerator:Current:Value, ConfigurationSection).
/*          MESSAGE SUBSTITUTE("Using &1->&2", usingSection:Key, usingSection:Value).*/
        
          DEFINE VARIABLE cLastPart AS CHARACTER NO-UNDO.
          cLastPart = SUBSTRING(usingSection:Value, R-INDEX(usingSection:Value, ".") + 1).
          keyvaluepairs:Add(NEW "System.Collections.Generic.KeyValuePair<character, character>"("using:" + cLastPart, usingSection:Value)).
        END. /*_USING*/
      END.
      ELSE IF configurationSection:Key = "MinimumLevel" THEN DO:
        DEFINE VARIABLE minLevelEnumerator AS "System.Collections.Generic.Dictionary<CHARACTER, System.Object>+Enumerator" NO-UNDO.
        minLevelEnumerator = configurationSection:GetChildren().
        _MINLEVEL:
        DO WHILE(minLevelEnumerator:MoveNext()):
          DEFINE VARIABLE minLevelSection AS ConfigurationSection NO-UNDO.
          minLevelSection = CAST(minLevelEnumerator:Current:Value, ConfigurationSection).

          IF minLevelSection:Key = "Default" THEN DO:
            keyvaluepairs:Add(NEW "System.Collections.Generic.KeyValuePair<character, character>"("minimum-level", minLevelSection:Value)). 
          END. 
          ELSE IF minLevelSection:Key = "Override" THEN DO:
            DEFINE VARIABLE overrideEnumerator AS "System.Collections.Generic.Dictionary<CHARACTER, System.Object>+Enumerator" NO-UNDO.
            overrideEnumerator = minLevelSection:GetChildren().
            _OVERRIDE:
            DO WHILE(overrideEnumerator:MoveNext()):
              DEFINE VARIABLE overrideSection AS ConfigurationSection NO-UNDO.
              overrideSection = CAST(overrideEnumerator:Current:Value, ConfigurationSection).
              
              keyvaluepairs:Add(NEW "System.Collections.Generic.KeyValuePair<character, character>"("minimum-level:override:" + overrideSection:Key, overrideSection:Value)).              
            END.
          END.
        END.        
      END.
      ELSE IF configurationSection:Key = "WriteTo" THEN DO:
        DEFINE VARIABLE writeToEnumerator AS "System.Collections.Generic.Dictionary<CHARACTER, System.Object>+Enumerator" NO-UNDO.
        writeToEnumerator = configurationSection:GetChildren().
        _WRITETO:
        DO WHILE(writeToEnumerator:MoveNext()):
          DEFINE VARIABLE writeToSection AS ConfigurationSection NO-UNDO.
          writeToSection = CAST(writeToEnumerator:Current:Value, ConfigurationSection).
          
          DEFINE VARIABLE writeToName AS CHARACTER NO-UNDO.
          
          DEFINE VARIABLE writeToSettingEnumerator AS "System.Collections.Generic.Dictionary<CHARACTER, System.Object>+Enumerator" NO-UNDO.
          writeToSettingEnumerator = writeToSection:GetChildren().
          _WRITETO_SETTINGS:
          DO WHILE(writeToSettingEnumerator:MoveNext()):
            DEFINE VARIABLE writeToSettingSection AS ConfigurationSection NO-UNDO.
            writeToSettingSection = CAST(writeToSettingEnumerator:Current:Value, ConfigurationSection).
            
/*            MESSAGE SUBSTITUTE("writeToSettingSection &1->&2", writeToSettingSection:Key, writeToSettingSection:Value).*/
            IF writeToSettingSection:Key = "Name" THEN DO:
              writeToName = writeToSettingSection:Value.
              keyvaluepairs:Add(NEW "System.Collections.Generic.KeyValuePair<System.String, System.String>"("write-to:" + writeToName, "")).
            END. 
            ELSE IF writeToSettingSection:Key = "Args" THEN DO:
              DEFINE VARIABLE argsEnumerator AS "System.Collections.Generic.Dictionary<CHARACTER, System.Object>+Enumerator" NO-UNDO.
              argsEnumerator = writeToSettingSection:GetChildren().
              _ARGS:
              DO WHILE(argsEnumerator:MoveNext()):
                DEFINE VARIABLE argsSection AS ConfigurationSection NO-UNDO.
                argsSection = CAST(argsEnumerator:Current:Value, ConfigurationSection).
                
/*                MESSAGE SUBSTITUTE("argsSection &1->&2", argsSection:Key, argsSection:Value).*/
                keyvaluepairs:Add(NEW "System.Collections.Generic.KeyValuePair<character, character>"("write-to:" + writeToName + "." + argsSection:Key, argsSection:Value)).
              END. /*_ARGS*/
              
            END.
          END. /*_WRITETO_SETTINGS*/
          
        END. /*_WRITETO*/
      END.
      
    END. /*SERILOG*/
    
/*    DEFINE VARIABLE kvpEnumerator AS "System.Collections.Generic.IEnumerator<System.Collections.Generic.KeyValuePair<character, character>>" NO-UNDO.*/
/*    kvpEnumerator = keyvaluepairs:GetEnumerator().                                                                                                   */
/*    DO WHILE(kvpEnumerator:MoveNext()):                                                                                                              */
/*      MESSAGE SUBSTITUTE("Serilog setting: &1=&2", kvpEnumerator:Current:Key, kvpEnumerator:Current:Value).                                          */
/*    END.                                                                                                                                             */

    loggerConfiguration:ReadFrom:KeyValuePairs(keyvaluepairs).
    Serilog.Log:Logger = loggerConfiguration:CreateLogger().

    Serilog.Log:Logger:Information("Serilog has been configured.").
  
  END METHOD.
  
  METHOD PUBLIC STATIC VOID SetOpenEdgeSettings(configuration AS Configuration):
    DEFINE VARIABLE openedgeSection AS ConfigurationSection NO-UNDO.
    openedgeSection = configuration:GetSection("OpenEdge").
    IF NOT VALID-OBJECT(openedgeSection) THEN DO:
      RETURN.
    END.
    
    DEFINE VARIABLE openedgeEnumerator AS "System.Collections.Generic.Dictionary<CHARACTER, System.Object>+Enumerator" NO-UNDO.
    openedgeEnumerator = openedgeSection:GetChildren().
    _OPENEDGE:
    DO WHILE(openedgeEnumerator:MoveNext()):
      
      DEFINE VARIABLE configurationSection AS ConfigurationSection NO-UNDO.
      configurationSection = CAST(openedgeEnumerator:Current:Value, ConfigurationSection).
      
/*      MESSAGE SUBSTITUTE("configurationSection &1->&2", configurationSection:Key, configurationSection:Value).*/
      
      IF configurationSection:Key = "startupProcedure" THEN DO:
        Bootstrap:StartupProcedure = configurationSection:Value.
      END.
      ELSE IF configurationSection:Key = "propath" THEN DO:
        PROPATH = configurationSection:Value.
      END.
      ELSE IF configurationSection:Key = "profiler" THEN DO:
        Bootstrap:UseProfiler = LOGICAL(configurationSection:VALUE).
      END.
      ELSE IF configurationSection:Key = "databases" THEN DO:
        DEFINE VARIABLE databaseSection AS ConfigurationSection NO-UNDO.
        DEFINE VARIABLE databasesEnumerator AS "System.Collections.Generic.Dictionary<CHARACTER, System.Object>+Enumerator" NO-UNDO.
        
        databasesEnumerator = configurationSection:GetChildren().
        _DATABASE:
        DO WHILE(databasesEnumerator:MoveNext()):
          databaseSection = CAST(databasesEnumerator:Current:Value, ConfigurationSection).
/*          MESSAGE SUBSTITUTE("databaseSection &1->&2", databaseSection:Key, databaseSection:Value).*/
          DEFINE VARIABLE dbSettingSection AS ConfigurationSection NO-UNDO.
          DEFINE VARIABLE databaseEnumerator AS "System.Collections.Generic.Dictionary<CHARACTER, System.Object>+Enumerator" NO-UNDO.
  
          DEFINE VARIABLE databaseConnectionString AS CHARACTER NO-UNDO.
          
          databaseEnumerator = databaseSection:GetChildren().
          _DB_SETTING:
          DO WHILE(databaseEnumerator:MoveNext()):
            dbSettingSection = CAST(databaseEnumerator:Current:Value, ConfigurationSection).
/*            MESSAGE SUBSTITUTE("dbSettingSection &1->&2", dbSettingSection:Key, dbSettingSection:Value).*/

            IF dbSettingSection:Key = ("db") THEN DO:
              databaseConnectionString = "-db " + dbSettingSection:Value.
            END.
            ELSE IF dbSettingSection:Key = ("host") THEN DO:
              databaseConnectionString = databaseConnectionString + " -H " + dbSettingSection:Value.
            END.
            ELSE IF dbSettingSection:Key = ("port") THEN DO:
              databaseConnectionString = databaseConnectionString + " -S " + dbSettingSection:Value.
            END.
            ELSE IF dbSettingSection:Key = ("logical") THEN DO:
              databaseConnectionString = databaseConnectionString + " -ld " + dbSettingSection:Value.
            END.
            ELSE IF dbSettingSection:Key = ("username") THEN DO:
              databaseConnectionString = databaseConnectionString + " -U " + dbSettingSection:Value.
            END.
            ELSE IF dbSettingSection:Key = ("password") THEN DO:
              databaseConnectionString = databaseConnectionString + " -P " + dbSettingSection:Value.
            END.
          END. /*_DB_SETTING*/

          IF databaseConnectionString <> "" THEN DO:
            Log:Information("Connecting to database with connection string (蔑铑邈糸镱郁蜷铉)...", BOX(databaseConnectionString)).
            CONNECT VALUE(databaseConnectionString) NO-ERROR.
            IF ERROR-STATUS:NUM-MESSAGES > 0 THEN DO:
              Log:Error("ERROR: Couldn't connect to database!").
              Log:Error("ERROR: 膨蝻蛲弩筢珏", BOX(ERROR-STATUS:GET-MESSAGE(1))).
            END.
          END.
          
        END. /*_DATABASE*/
        
      END. /*databases*/
      
    END. /*_OPENEDGE*/

  END METHOD.
  

END CLASS.